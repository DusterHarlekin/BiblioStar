import{R,r as q,aw as j,bb as L,V as Q,W as $,X as i,Y as r,b0 as G,Z as a,az as F,$ as s,a3 as H,b2 as c,x as I,bd as J,_ as w,aA as B,S as K,a2 as S,a0 as W}from"./index.3de14beb.js";import{Q as D}from"./QSelect.dcde8888.js";import{Q as P}from"./QTooltip.2c191821.js";import{Q as X}from"./QTd.4e40a178.js";import{Q as Y}from"./QTable.bd81f58f.js";import{Q as Z}from"./QPage.ea495e0d.js";import{Q as M}from"./QForm.56ccee4c.js";import{u as N}from"./use-dialog-plugin-component.65dc1751.js";import"./QItem.5c0ffacc.js";import"./QMenu.ba121aec.js";import"./format.054b8074.js";import"./QList.d82f2d18.js";const ee={class:"text-h6"},oe={class:"col-auto"},O={__name:"UserForm",props:{isEditForm:{type:Boolean,default:!1},cedula:{type:String,default:null}},emits:[...N.emits],setup(_){const h=R(),{dialogRef:u,onDialogHide:b,onDialogOK:t,onDialogCancel:V}=N(),m=_,y=q(!0),p=j({record:{cedula:"",nombre:"",apellido:"",usuario:"",clave:"",rol:"",request:"Register",session_user_name:localStorage.getItem("usuario"),session_user_role:localStorage.getItem("rol")}}),g=async()=>{try{if(m.isEditForm){const l={method:"GET",headers:{"Content-Type":"application/json"}},e=`http://localhost/bibliostar/API/auth/auth.php?cedula=${m.cedula}&session_user_name=${localStorage.getItem("usuario")}&session_user_role=${localStorage.getItem("rol")}`,o=await fetch(e,l);if(!o.ok)throw new Error(o.statusText);const d=await o.json();if(d.error)throw new Error(d.error);p.record=d[0],p.record.clave="",p.record.session_user_name=localStorage.getItem("usuario"),p.record.session_user_role=localStorage.getItem("rol")}}catch(l){h.notify({color:"negative",position:"top",message:l.message,icon:"mdi-alert"})}},E=async()=>{try{const l={method:m.isEditForm?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p.record)},e=await fetch("http://localhost/bibliostar/API/auth/auth.php",l);if(!e.ok)throw new Error(e.statusText);const o=await e.json();if(o.error)throw new Error(o.error);h.notify({color:"positive",position:"top",message:o.success,icon:"mdi-checkbox-marked-circle"}),t({})}catch(l){h.notify({color:"negative",position:"top",message:l.message,icon:"mdi-alert"})}};m.isEditForm&&g();const U=()=>V(),{record:n,isLoading:k}=L(p);return(l,e)=>(Q(),$(G,{ref_key:"dialogRef",ref:u,medium:"","full-height":"",maximized:"",position:"right",onHide:r(b)},{default:i(()=>[a(B,{class:"q-pa-md",style:{width:"500px","max-width":"100vw"}},{default:i(()=>[a(F,null,{default:i(()=>[s("div",ee,H(_.isEditForm?"Editar":"Nuevo")+" Usuario",1)]),_:1}),a(M,{onSubmit:E},{default:i(()=>[a(F,null,{default:i(()=>[a(c,{disable:_.isEditForm,modelValue:r(n).cedula,"onUpdate:modelValue":e[0]||(e[0]=o=>r(n).cedula=o),label:"C\xE9dula",class:"required"},null,8,["disable","modelValue"]),a(c,{modelValue:r(n).nombre,"onUpdate:modelValue":e[1]||(e[1]=o=>r(n).nombre=o),label:"Nombre",class:"required"},null,8,["modelValue"]),a(c,{modelValue:r(n).apellido,"onUpdate:modelValue":e[2]||(e[2]=o=>r(n).apellido=o),label:"Apellido",class:"required"},null,8,["modelValue"]),a(c,{modelValue:r(n).usuario,"onUpdate:modelValue":e[3]||(e[3]=o=>r(n).usuario=o),label:"Usuario",class:"required"},null,8,["modelValue"]),a(c,{modelValue:r(n).clave,"onUpdate:modelValue":e[5]||(e[5]=o=>r(n).clave=o),label:"Contrasen\u0303a",type:y.value?"password":"text"},{append:i(()=>[a(I,{name:y.value?"visibility_off":"visibility",class:"cursor-pointer",onClick:e[4]||(e[4]=o=>y.value=!y.value)},null,8,["name"])]),_:1},8,["modelValue","type"]),s("div",oe,[a(D,{modelValue:r(n).rol,"onUpdate:modelValue":e[6]||(e[6]=o=>r(n).rol=o),"map-options":"","emit-value":"",options:[{label:"Administrador",value:"admin"},{label:"Bibliotecario",value:"librarian"}],label:"Rol"},null,8,["modelValue"])])]),_:1}),a(J,null,{default:i(()=>[a(w,{loading:r(k),type:"submit",color:"primary",label:"Guardar",padding:"xs xl"},null,8,["loading"]),a(w,{flat:"",label:"Cancelar",onClick:U})]),_:1})]),_:1})]),_:1})]),_:1},8,["onHide"]))}},ae={class:"row justify-between items-center q-gutter-x-xl q-gutter-y-md q-mb-md q-pt-sm"},le={class:"col-md-6"},te={class:"row q-gutter-sm items-center"},se={class:"col-auto"},ie={class:"row justify-between content-end items-center q-col-gutter-sm"},re={class:"col-auto"},ne={class:"row items-center"},de={class:"col-xs-12 col-lg-auto"},ue={class:"row items-center q-gutter-md"},ce={class:"col-auto"},me={class:"col-auto"},pe={class:"col-auto"},ge={class:"col-auto"},fe={class:"col-auto"},be={class:"col-auto self-end"},Pe={__name:"UserList",setup(_){const h=K(),u=R(),b=q({page:1,rowsPerPage:10,rowsNumber:0}),t=j({cedula:"",usuario:"",rol:"",nombre:"",apellido:""}),V=q([]),m=q(!1),y=[{name:"usuario",label:"Usuario",field:"usuario",align:"left"},{name:"cedula",label:"C\xE9dula",field:"cedula",align:"left"},{name:"nombre",label:"Nombre",field:"nombre",align:"left"},{name:"apellido",label:"Apellido",field:"apellido",align:"left"},{name:"rol",label:"Rol",field:l=>{switch(l.rol){case"admin":return"Administrador";case"librarian":return"Bibliotecario";default:return"--"}},align:"left"},{name:"actions",label:"Acciones",align:"left"}],p=l=>{u.dialog({title:"Eliminar pa\xEDs",message:`\xBFEst\xE1s seguro de que deseas eliminar este usuario? (${l.usuario})`,cancel:!0,persistent:!0}).onOk(async()=>{try{const e={method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({cedula:l.cedula,session_user_name:localStorage.getItem("usuario"),session_user_role:localStorage.getItem("rol")})},d=await fetch("http://localhost/bibliostar/API/auth/auth.php",e);if(!d.ok)throw new Error(d.statusText);const v=await d.json();if(v.error)throw new Error(v.error);u.notify({color:"positive",position:"top",message:v.success,icon:"mdi-check"}),g()}catch(e){u.notify({color:"negative",position:"top",message:e.message,icon:"mdi-alert"})}})},g=async(l=1)=>{var e,o,d;try{const v={method:"GET",headers:{"Content-Type":"application/json"}};let T=`http://localhost/bibliostar/API/auth/auth.php?page=${l}&session_user_name=${localStorage.getItem("usuario")}&session_user_role=${localStorage.getItem("rol")}`,C=new URLSearchParams(t),A=[];C.forEach((x,z)=>{x.trim()==""&&A.push(z)}),A.forEach(x=>{C.delete(x)}),C.toString()!=""&&(T+=`&${C.toString()}`),m.value=!0;const f=await(await fetch(T,v)).json();V.value=f.data?f.data:[],b.value.rowsNumber=(e=f.pagination)!=null&&e.total?f.pagination.total:0,b.value.page=(o=f.pagination)!=null&&o.currentPage?f.pagination.currentPage:1,b.value.rowsPerPage=(d=f.pagination)!=null&&d.perPage?f.pagination.perPage:10}catch(v){u.notify({color:"negative",position:"top",message:v.message,icon:"mdi-alert"})}finally{m.value=!1}},E=l=>{g(l.pagination.page)},U=()=>{t.usuario="",t.cedula="",t.rol="",t.nombre="",t.apellido=""},n=async()=>{u.dialog({component:O,componentProps:{isEditForm:!1}}).onOk(async()=>{await g()})},k=async l=>{u.dialog({component:O,componentProps:{isEditForm:!0,cedula:l.cedula}}).onOk(async()=>{await g()})};return g(),(l,e)=>(Q(),$(Z,{class:"q-py-md q-px-lg"},{default:i(()=>[s("div",ae,[s("div",le,[s("div",te,[a(I,{name:"mdi-account",size:"lg",color:"primary"}),e[7]||(e[7]=s("div",{class:"text-h4 text-weight-medium font-title"},"Usuarios",-1))])]),s("div",se,[a(w,{label:"Nuevo Usuario",icon:"mdi-plus-circle",color:"secondary","text-color":"white",onClick:n})])]),a(B,{class:"q-pa-md q-mb-lg"},{default:i(()=>[s("div",ie,[s("div",re,[s("div",ne,[s("div",de,[s("div",ue,[a(I,{name:"mdi-filter-variant",size:"lg",color:"grey-10"}),s("div",ce,[a(c,{modelValue:t.cedula,"onUpdate:modelValue":e[0]||(e[0]=o=>t.cedula=o),outlined:"",dense:"",debounce:"400",label:"Cedula"},null,8,["modelValue"])]),s("div",me,[a(c,{modelValue:t.usuario,"onUpdate:modelValue":e[1]||(e[1]=o=>t.usuario=o),outlined:"",dense:"",debounce:"400",label:"Usuario"},null,8,["modelValue"])]),s("div",pe,[a(D,{modelValue:t.rol,"onUpdate:modelValue":e[2]||(e[2]=o=>t.rol=o),style:{"min-width":"140px"},"map-options":"",dense:"",outlined:"","emit-value":"",options:[{label:"Administrador",value:"admin"},{label:"Bibliotecario",value:"librarian"}],label:"Rol"},null,8,["modelValue"])]),s("div",ge,[a(c,{modelValue:t.nombre,"onUpdate:modelValue":e[3]||(e[3]=o=>t.nombre=o),outlined:"",dense:"",debounce:"400",label:"Nombre"},null,8,["modelValue"])]),s("div",fe,[a(c,{modelValue:t.apellido,"onUpdate:modelValue":e[4]||(e[4]=o=>t.apellido=o),outlined:"",dense:"",debounce:"400",label:"Apellido"},null,8,["modelValue"])])])])])]),s("div",be,[a(w,{flat:"",size:"lg","no-caps":"",icon:"mdi-eraser",color:"negative",onClick:U}),a(w,{flat:"",size:"lg","no-caps":"",icon:"mdi-reload",color:"primary",class:"q-ml-sm",onClick:e[5]||(e[5]=o=>g())},{default:i(()=>[a(P,null,{default:i(()=>e[8]||(e[8]=[S(" Actualizar tabla ")])),_:1})]),_:1})])])]),_:1}),a(Y,{flat:"",dense:r(u).screen.lt.lg,bordered:"",pagination:b.value,"onUpdate:pagination":e[6]||(e[6]=o=>b.value=o),rows:V.value,columns:y,filter:t,loading:m.value,"row-key":"cedula","rows-per-page-options":[],onRequest:E},{"body-cell-actions":i(o=>[a(X,{props:o},{default:i(()=>[a(w,{flat:"",round:"",icon:"mdi-lead-pencil",color:"accent",onClick:d=>k(o.row)},{default:i(()=>[a(P,null,{default:i(()=>e[9]||(e[9]=[S("Editar")])),_:1})]),_:2},1032,["onClick"]),o.row.usuario!=r(h).usuario?(Q(),$(w,{key:0,flat:"",round:"",icon:"mdi-delete-variant",color:"red",onClick:d=>p(o.row)},{default:i(()=>[a(P,null,{default:i(()=>e[10]||(e[10]=[S("Eliminar")])),_:1})]),_:2},1032,["onClick"])):W("",!0)]),_:2},1032,["props"])]),_:1},8,["dense","pagination","rows","filter","loading"])]),_:1}))}};export{Pe as default};
