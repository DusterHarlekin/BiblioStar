import{R as j,P as R,b1 as U,r as y,aw as z,bb as A,V as B,W as G,X as l,$ as c,Z as a,_ as w,x as q,a3 as L,Y as i,aA as D,az as J,a2 as S,b2 as W}from"./index.3de14beb.js";import{Q as x,b as k}from"./QItem.5c0ffacc.js";import{Q as I}from"./QSelect.dcde8888.js";import{Q as X}from"./QForm.56ccee4c.js";import{Q as Y}from"./QPage.ea495e0d.js";import{_ as Z}from"./ReaderForm.0f6c1019.js";import"./QMenu.ba121aec.js";import"./format.054b8074.js";import"./use-dialog-plugin-component.65dc1751.js";const H={class:"flex justify-between"},K={class:"row q-gutter-sm items-center q-mb-md q-pt-sm"},M={class:"text-h5 text-weight-medium font-title text-grey-9"},ee={class:"text-right font-title"},oe={class:"row"},te={class:"col-12"},pe={__name:"LoanForm",setup(se){const d=j(),Q=R(),b=U(),E=y(!1),f=y([]),u=y([]),m=!!(b.path.includes("editar")&&b.params.id),s=z({record:{cod_isbn:"",titulo:"",cedula:"",observacion:"",session_user_name:localStorage.getItem("usuario"),session_user_role:localStorage.getItem("rol")}}),F=(e,t)=>{t(async()=>{if(e.length>0){let o=await g({cedula:e},"lectores");if(u.value=[],o.data)for(const r of o.data)u.value.push({label:`${r.cedula} - ${r.nombre} ${r.apellido}`,value:r.cedula})}})},V=(e,t)=>{t(async()=>{if(e.length>0){let o=await g({cod_isbn:e},"libros");if(f.value=[],o.data)for(const r of o.data)f.value.push({label:`${r.cod_isbn} - ${r.titulo}`,value:r.cod_isbn,titulo:r.titulo})}})},g=async(e,t)=>{try{const o={method:"GET",headers:{"Content-Type":"application/json"}};let r=`http://localhost/bibliostar/API/${t}.php?page=1&session_user_name=${localStorage.getItem("usuario")}&session_user_role=${localStorage.getItem("rol")}`,p=new URLSearchParams(e),$=[];p.forEach((v,O)=>{v.trim()==""&&$.push(O)}),$.forEach(v=>{p.delete(v)}),p.toString()!=""&&(r+=`&${p.toString()}`);const _=await fetch(r,o);if(!_.ok)throw new Error(_.statusText);const h=await _.json();if(h.error)throw new Error(h.error);return h}catch(o){d.notify({color:"negative",position:"top",message:o.message,icon:"mdi-alert"})}},T=async()=>{try{if(m){const e={method:"GET",headers:{"Content-Type":"application/json"}},t=`http://localhost/bibliostar/API/prestamos.php?cod_isbn=${b.params.id}&session_user_name=${localStorage.getItem("usuario")}&session_user_role=${localStorage.getItem("rol")}`,o=await fetch(t,e);if(!o.ok)throw new Error(o.statusText);const r=await o.json();if(r.error)throw new Error(r.error);s.record=r[0],s.record.cod_isbn={label:`${s.record.cod_isbn} - ${s.record.titulo}`,value:s.record.cod_isbn,titulo:s.record.titulo},s.record.session_user_name=localStorage.getItem("usuario"),s.record.session_user_role=localStorage.getItem("rol")}}catch(e){d.notify({color:"negative",position:"top",message:e.message,icon:"mdi-alert"})}},C=async e=>{s.record.titulo=e.titulo},N=async()=>{try{s.record.observacion=s.record.observacion?s.record.observacion:"NINGUNA",s.record.cod_isbn=s.record.cod_isbn.value?s.record.cod_isbn.value:s.record.cod_isbn;const e={method:m?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s.record)},t=await fetch("http://localhost/bibliostar/API/prestamos.php",e);if(!t.ok)throw new Error(t.statusText);const o=await t.json();if(o.error)throw new Error(o.error);d.notify({color:"positive",position:"top",message:o.success,icon:"mdi-checkbox-marked-circle"}),Q.push({path:"/prestamos"})}catch(e){d.notify({color:"negative",position:"top",message:e.message,icon:"mdi-alert"})}},P=async()=>{d.dialog({component:Z,componentProps:{creatingFromLoan:!0,isEditForm:!1}}).onOk(async e=>{await g({cedula:e.cedula},"lectores"),u.value=[],u.value.push({label:`${e.reader.cedula} - ${e.reader.nombre} ${e.reader.apellido}`,value:e.reader.cedula}),s.record.cedula=e.reader.cedula})};T();const{record:n}=A(s);return(e,t)=>(B(),G(Y,{class:"q-px-lg q-py-sm"},{default:l(()=>[c("div",H,[c("div",K,[a(w,{icon:"mdi-chevron-left",flat:"",color:"primary",padding:"none",to:"/prestamos",size:"lg",class:"q-mr-sm"}),a(q,{name:"mdi-book",size:"md",color:"grey-9"}),c("div",M,L(i(m)?"Editar":"Nuevo")+" Pr\xE9stamo ",1)]),c("div",ee,[a(w,{size:"md",class:"q-my-md",loading:E.value,color:"primary",padding:"sm md",icon:"mdi-check-circle-outline",label:"Guardar",onClick:N},null,8,["loading"])])]),a(X,null,{default:l(()=>[a(D,null,{default:l(()=>[c("div",oe,[c("div",te,[a(J,{class:"q-pb-none"},{default:l(()=>[a(I,{modelValue:i(n).cod_isbn,"onUpdate:modelValue":[t[0]||(t[0]=o=>i(n).cod_isbn=o),t[1]||(t[1]=o=>C(o))],label:"C\xF3digo ISBN",class:"required q-mt-md","use-input":"","input-debounce":"400","option-label":"label","option-value":"value","map-options":"",outlined:"",options:f.value,onFilter:V,disable:i(m)},{"no-option":l(()=>[a(x,null,{default:l(()=>[a(k,{class:"text-grey"},{default:l(()=>t[4]||(t[4]=[S(" No se encontraron resultados ")])),_:1})]),_:1})]),_:1},8,["modelValue","options","disable"]),a(I,{modelValue:i(n).cedula,"onUpdate:modelValue":t[2]||(t[2]=o=>i(n).cedula=o),label:"C\xE9dula del lector",class:"required q-mt-md","use-input":"","input-debounce":"400","option-label":"label","option-value":"value","emit-value":"","map-options":"",outlined:"",options:u.value,onFilter:F},{"no-option":l(()=>[a(x,null,{default:l(()=>[a(k,{class:"text-grey"},{default:l(()=>t[5]||(t[5]=[S(" No se encontraron resultados ")])),_:1})]),_:1})]),after:l(()=>[a(w,{color:"primary",onClick:P,class:"q-px-sm q-py-sm"},{default:l(()=>[a(q,{name:"mdi-plus",size:"lg"})]),_:1})]),_:1},8,["modelValue","options"]),a(W,{modelValue:i(n).observacion,"onUpdate:modelValue":t[3]||(t[3]=o=>i(n).observacion=o),label:"Observaciones",class:"required q-my-md",outlined:"",type:"textarea"},null,8,["modelValue"])]),_:1})])])]),_:1})]),_:1})]),_:1}))}};export{pe as default};
